---
title: "Survival models"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true 
vignette: >
  %\VignetteIndexEntry{Survival models}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
library(heemod)
library(dplyr)
library(survival)
library(flexsurv)
```

The heemod package provides a number of ways to estimate transition probabilties from survival distributions.  Survival distributions in heemod can come from at least three different sources:

+ User-definded parametric distributions

+ Fitted parametric distributions (`flexsurv::flexsurvreg`)

+ Fitted Kaplan-Meiers (`survival::survfit`)

Once defined, each of these types of distributions can be combined and modified using a standard set of operations.

User-defined parametric distributions are created using the `define_survival` and `define_spline_survival` functions:
```{r}

surv_dist1 <- define_survival(
  distribution = "exp",
  rate = .5
)

surv_dist2 <- define_spline_survival(
  scale = "odds",
  gamma = c(-11.643, 1.843, 0.208),
  knots = c(4.077537, 5.883183, 6.458338)
)

```

Fitted parametric models are created using `flexsurv::flexsurvreg` and `flexsurv::flexsurvspline`:

```{r fig.width=6, fig.height=6}


fitw <- flexsurvreg(
  formula = Surv(futime, fustat) ~ 1,
  data = ovarian, dist = "weibull"
)
plot(fitw)


fitspl <- flexsurvspline(
  formula = Surv(futime, fustat) ~ 1,
  data = ovarian,
  scale = "odds",
  k=1
)
plot(fitspl)

```

Fitted models can include covariates.  In order to use a model with covariates in heemod, you can use the `set_covariates` function on the fitted model and provide as additional arguments the covariate values you want to model.  You can also provide a data.frame of covariate levels to aggregate survival probabilites over different groups.  By default, heemod will aggregate over predicted survival probabilities for each subject in the dataset to which the model was fit.

```{r fig.width=6, fig.height=6}


fitcov <- flexsurvreg(
  formula = Surv(rectime, censrec) ~ group,
  data = bc, dist = "weibull"
)

plot(fitw)

fitcov_good <- fitcov %>% set_covariates(group = "Good")
fitcov_medium <- fitcov %>% set_covariates(group = "Medium")
fitcov_poor <- fitcov %>% set_covariates(group = "Poor")

```


Similar functionality is also available for Kaplan-Meiers created using `survival::survfit`
```{r}

km1 <- survfit(
  formula = Surv(futime, fustat) ~ 1,
  data = ovarian
)
kmcov <- survfit(
  formula = Surv(rectime, censrec) ~ group,
  data = bc
)
plot(kmcov)

km_good <- kmcov %>% set_covariates(group = "Good")
km_medium <- kmcov %>% set_covariates(group = "Medium")
km_poor <- kmcov %>% set_covariates(group = "Poor")

```

Once defined, treatment effects of various types can be applied to any survival distribution:

+ Hazard ratio: `apply_hr`

+ Odds ratio: `apply_or`

+ Acceleration factor: `apply_af`

```{r}
km_poor_ph <- km_poor %>% apply_hr(hr=0.5)
km_medium_af <- km_medium %>% apply_af(af=1.2)

```

In addition, distributions can be combined using a variety of operations:

+ Use one (or more) survival distributions to project from another: `project`

+ Pool two (or more) survival distributions: `pool`

+ Combine two (or more) survival distributions as independent risks: `add_hazards`

```{r}

km_poor_proj = km_poor %>% project(fitcov_poor, at=365)
models_all = pool(fitcov_good, fitcov_medium, fitcov_poor, weights=c(0.25, 0.25, 0.5))
combined_risks = add_hazards(fitw, fitcov_good)

```


For the example we define a simple model with only 1 strategy.

```{r warning=FALSE}
param <- define_parameters(
  p1 = eval_surv(
    surv_dist1,
    cycle = markov_cycle # can also be state_cycle
  ),
  p2 = km_medium %>%
    project(fitcov_medium, at = 730) %>%
    eval_surv(markov_cycle, cycle_length = 365) # time is in days in fitw, in years in markov_cycle
)

tm <- define_transition(
  C, p1, 0,
  0, C,  p2,
  0, 0,  C
)

plot(tm)

sA <-  define_state(
  cost = 10, ut = 1
)
sB <-  define_state(
  cost = 20, ut = .5
)
sC <-  define_state(
  cost = 0, ut = 0
)

stratTM <- define_strategy(
  transition = tm,
  A = sA, B = sB, C = sC
)

resTM <- run_model(
  parameters = param,
  stratTM,
  cycles = 10
)
```

```{r fig.width=6}
plot(resTM)
```

A partitioned survival model can also be computed:

```{r warning=FALSE}
ps <- define_part_surv(
  pfs = surv_dist1,
  os = km1 %>%
    project(fitw, at = 730),
     cycle_length = c(1, 365) # 1 for pfs, 365 for os
)

stratPS <- define_strategy(
  transition = ps,
  A = sA, B = sB, C = sC
)

resPS <- run_model(
  stratPS,
  cycles = 10
)
```

```{r fig.width=6}
plot(resPS)
```
